-- TARGETED MIGRATION BASED ON YOUR ACTUAL DATA
BEGIN;

-- 1. Create backup (lightweight since you don't have much data)
CREATE TABLE projects_backup AS SELECT * FROM projects;
CREATE TABLE project_assignments_backup AS SELECT * FROM project_assignments;

-- 2. Check all user ID formats first
SELECT DISTINCT 
  table_name,
  column_name,
  data_type,
  (SELECT COUNT(*) FROM information_schema.columns c2 
   WHERE c2.table_name = c.table_name 
   AND c2.column_name = c.column_name) as count
FROM information_schema.columns c
WHERE column_name IN ('user_id', 'assignee_id', 'created_by', 'submitted_by', 'uploaded_by')
  AND table_schema = 'public'
ORDER BY data_type, table_name;

-- 3. Fix the INTEGER columns that should be VARCHAR
-- Since assignee_id has no data, this is safe
ALTER TABLE projects 
  ALTER COLUMN assignee_id TYPE VARCHAR;

-- Check if any other tables have integer user references with no data
DO $$ 
DECLARE
  r RECORD;
BEGIN
  FOR r IN (
    SELECT table_name, column_name 
    FROM information_schema.columns 
    WHERE data_type = 'integer' 
    AND column_name IN ('assignee_id', 'user_id', 'created_by')
    AND table_schema = 'public'
  )
  LOOP
    EXECUTE format('ALTER TABLE %I ALTER COLUMN %I TYPE VARCHAR', r.table_name, r.column_name);
    RAISE NOTICE 'Converted %.% to VARCHAR', r.table_name, r.column_name;
  END LOOP;
END $$;

-- 4. Fix the duplicate columns in projects
-- Check what's in the duplicate columns first
SELECT 
  COUNT(estimated_hours) as estimated_count,
  COUNT(estimatedhours) as duplicate_estimated_count,
  COUNT(start_date) as start_date_count,
  COUNT(startdate) as duplicate_start_count
FROM projects;

-- Since you likely have no data in these, just drop the duplicates
ALTER TABLE projects 
  DROP COLUMN IF EXISTS estimatedhours,
  DROP COLUMN IF EXISTS actualhours,
  DROP COLUMN IF EXISTS startdate,
  DROP COLUMN IF EXISTS enddate,
  DROP COLUMN IF EXISTS risklevel,
  DROP COLUMN IF EXISTS stakeholders,
  DROP COLUMN IF EXISTS milestones;

-- 5. Clean up the denormalized name columns (they're probably empty anyway)
-- First check if they have data
SELECT 
  'projects.assignee_name' as column_check,
  COUNT(assignee_name) as non_null_count
FROM projects WHERE assignee_name IS NOT NULL
UNION ALL
SELECT 
  'projects.created_by_name',
  COUNT(created_by_name)
FROM projects WHERE created_by_name IS NOT NULL;

-- If empty (likely), drop them
ALTER TABLE projects DROP COLUMN IF EXISTS assignee_name;
ALTER TABLE projects DROP COLUMN IF EXISTS assignee_names;
ALTER TABLE projects DROP COLUMN IF EXISTS created_by_name;

-- 6. Drop other denormalized names across all tables
DO $$ 
DECLARE
  r RECORD;
BEGIN
  FOR r IN (
    SELECT table_name, column_name 
    FROM information_schema.columns 
    WHERE column_name IN ('assignee_name', 'assignee_names', 'created_by_name', 
                          'uploaded_by_name', 'user_name', 'volunteer_name')
    AND table_schema = 'public'
  )
  LOOP
    EXECUTE format('ALTER TABLE %I DROP COLUMN IF EXISTS %I', r.table_name, r.column_name);
    RAISE NOTICE 'Dropped %.%', r.table_name, r.column_name;
  END LOOP;
END $$;

-- 7. Create the essential indexes
CREATE INDEX IF NOT EXISTS idx_projects_assignee_id ON projects(assignee_id);
CREATE INDEX IF NOT EXISTS idx_projects_status ON projects(status);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_project_assignments_user_id ON project_assignments(user_id);

-- 8. Verify the migration worked
SELECT 
  'Migration successful' as status,
  (SELECT COUNT(*) FROM information_schema.columns 
   WHERE column_name IN ('estimatedhours', 'actualhours', 'assignee_name')
   AND table_schema = 'public') = 0 as duplicate_columns_removed,
  (SELECT COUNT(DISTINCT data_type) FROM information_schema.columns 
   WHERE column_name IN ('user_id', 'assignee_id', 'created_by')
   AND table_schema = 'public') as unique_user_id_types;

COMMIT;